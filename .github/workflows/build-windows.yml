name: Build Windows Application

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        
    - name: Install FFmpeg
      run: |
        choco install ffmpeg -y
        
    - name: Cache pip packages
      uses: actions/cache@v3
      with:
        path: ~\AppData\Local\pip\Cache
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: Build executable with PyInstaller
      run: |
        pyinstaller --name="VoiceTranslator" ^
          --windowed ^
          --onedir ^
          --add-data "config.py;." ^
          --hidden-import="PyQt6" ^
          --hidden-import="PyQt6.QtCore" ^
          --hidden-import="PyQt6.QtGui" ^
          --hidden-import="PyQt6.QtWidgets" ^
          --hidden-import="faster_whisper" ^
          --hidden-import="transformers" ^
          --hidden-import="TTS" ^
          --hidden-import="TTS.api" ^
          --hidden-import="TTS.utils" ^
          --hidden-import="torch" ^
          --hidden-import="torchaudio" ^
          --hidden-import="librosa" ^
          --hidden-import="soundfile" ^
          --hidden-import="ffmpeg" ^
          --hidden-import="numpy" ^
          --hidden-import="scipy" ^
          --collect-all="TTS" ^
          --collect-all="transformers" ^
          --collect-all="faster_whisper" ^
          --collect-all="torch" ^
          --collect-all="torchaudio" ^
          --collect-submodules="torch" ^
          --collect-submodules="transformers" ^
          --copy-metadata="torch" ^
          --copy-metadata="transformers" ^
          --copy-metadata="TTS" ^
          --exclude-module="matplotlib" ^
          --exclude-module="tkinter" ^
          --exclude-module="IPython" ^
          --exclude-module="jupyter" ^
          main.py
      shell: cmd
      
    - name: Create release archive
      run: |
        mkdir release
        xcopy /E /I dist\VoiceTranslator release\VoiceTranslator
        copy README.md release\
        copy QUICKSTART.md release\
        copy requirements.txt release\
        echo Models will be downloaded on first run (approx. 7-8 GB) > release\FIRST_RUN.txt
        echo. >> release\FIRST_RUN.txt
        echo To run: Open VoiceTranslator folder and run VoiceTranslator.exe >> release\FIRST_RUN.txt
      shell: cmd
      
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: VoiceTranslator-Windows
        path: release/
        
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: release/*
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
